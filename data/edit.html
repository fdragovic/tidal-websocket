<!doctype html>
<meta charset="utf-8" />

<html lang="en">

<head>
<link rel="stylesheet" href="lib/codemirror.css">
<link rel="stylesheet" href="css/paraiso-dark.css">
<link rel="stylesheet" href="css/spicule.css">
<link rel="stylesheet" href="lib/jquery-ui-1.12.1/jquery-ui.css">

<style>
  body {
    /* background-color:  #002b36; */
    background-color:  #000;
  }
  #code {
  }
  #dummycode {
    display: none;
  }
</style>

<script src="lib/jquery-3.1.1.min.js"></script>
<script src="lib/jquery-ui-1.12.1/jquery-ui.js"></script>
<script src="lib/codemirror.js"></script>
<script src="lib/emacs.js"></script>
<script src="lib/matchbrackets.js"></script>
<script src="lib/comment.js"></script>
<script src="lib/dialog.js"></script>
<script src="lib/searchcursor.js"></script>
<script src="lib/search.js"></script>
<script src="lib/haskell.js"></script>
<script src="lib/osc-browser.js"></script>

<script>
  var editor, dummyEditor;
  $( function() {
      var connected = false;
      // list of list of changes
      var changeList = [];
      var recordChanges= true;
  
      $("#slider").slider({
        start: function(event, ui) {
          $("#codediv").hide();
          $("#dummycodediv").show();
        },
        stop: function(event, ui) {
          $("#codediv").show();
          $("#dummycodediv").hide();
        },
        slide: function(event, ui) {
          var pc = ui.value / 100.0;
          var changeN = Math.floor(pc * changeList.length);

          dummyEditor.setValue("");
          if (changeN > 0) {
            for (i=0; i < changeN; ++i) {
              var change = changeList[i];
              dummyEditor.replaceRange(change.text, change.from, change.to);
            }
	  }
        }
      });
      var ws = new WebSocket('ws://localhost:9162', ['soap']);
      ws.onmessage = function (e) { console.log("msg: " + e.data) };
      ws.onerror = function (error) { console.log("ws error" + error) };
      
      CodeMirror.commands.save = function() {
        var elt = editor.getWrapperElement();
        elt.style.background = "#def";
        setTimeout(function() { elt.style.background = ""; }, 300);
      };
      var editorOptions = {
        lineNumbers: true,
        mode: "text/x-haskell",
        keyMap: "emacs"
      };
      editor = CodeMirror.fromTextArea(document.getElementById("code"), editorOptions);
      editor.setOption('readOnly', true);
      editor.setOption('theme', "solarized dark");
      dummyEditor = CodeMirror.fromTextArea(document.getElementById("dummycode"), editorOptions);
      dummyEditor.setOption('readOnly', true);
      dummyEditor.setOption('theme', "solarized dark");
  
      ws.onopen = function () {
        // ws.send('/join alex'); // Send the message 'Ping' to the server
        connected = true;
        editor.setOption('readOnly', false);
      };

      editor.on('change',
         function (editor, change) {
          var secs = (new Date().getTime()) / 1000.0;
          console.log("change: " + secs + " obj: " + change + " of " + change.from.line);
          change.when = secs;
          changeList.push(change);
          // ws.send("/change " + secs);
          // return false so codemirror handles the event
          return(false);
        }
      );
      editor.setOption("extraKeys", {
        "Ctrl-.": function(cm) {
           ws.send("/eval silence");
        },
        "Ctrl-0": function(cm) {
           ws.send("/panic");
        },
        "Ctrl-Enter": function(cm) {
          var selection;

          if (!connected) {
             return(false);
          }

          if (cm.somethingSelected()) {
            selection = cm.getSelection();
          }
          else {
            var pos = cm.getCursor();
            var nonempty = /\S/;
            selection = cm.getLine(pos.line);
            if (nonempty.test(selection)) {
              var above = pos.line - 1;
              // todo check for non-whitespace
              while (above >= 0 && nonempty.test(cm.getLine(above))) {
                selection = cm.getLine(above) + "\n" + selection;
                above--;
              }
              var below = pos.line + 1;
              while (below < cm.lineCount() && nonempty.test(cm.getLine(below))) {
                selection = selection + "\n" + cm.getLine(below);
                below++;
              }
              var c = cm.getCursor();

              // highlight evaluated area
              // make editor temporarily read only so that the selection doesn't get 
              // overwritten by fast typing..
              cm.setOption('readOnly', true);
              cm.setSelection({line: above+1, ch: 0}, {line: below, ch:0});
              setTimeout(function(){cm.setCursor(c);cm.setOption('readOnly', false);},100);
            }
          }
          console.log("eval: " + selection);
          ws.send("/eval " + selection);
          // var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
          // cm.replaceSelection(spaces);
        }
      });
  });

  </script>
</head>  

<body>
    <div id="slider"></div>
    <table>
      <tr>
<td width="80px" valign="top"><img src="images/cc-800.png" width="80px"/><br />
<td width="800px"><form>
    <div id="codediv">
    <textarea id="code" name="code" cols="80">
    </textarea>
    </div>
    <div id="dummycodediv">
      <textarea id="dummycode" name="dummycode" cols="80">
      </textarea>
    </div>
 </form>
    </td></tr></table>
</body>
</html>
